<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">

  <style>
    body {
      font-family: Calibri, sans-serif;
      font-size: 11pt;
      padding: 20px;
    }
    .incident {
      margin-bottom: 30px;
    }
    hr {
      border: 1px solid #ccc;
    }
    .title {
      font-weight: bold;
      color: red;
    }
    .incident { margin-bottom: 18px; }
    .muted { color:#666; }
    .section-title { font-weight:bold; margin:18px 0 8px; }
    .spacer { height: 14px; line-height:14px; }
    h3 { margin:0 0 12px 0; }
      .section-title { font-weight:bold; margin:18px 0 8px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 6px 8px; vertical-align: top; }
      th { background-color: #f5f5f5; text-align: left; }
    pre {
      background: none;
      border: none;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: Calibri, sans-serif;
      font-size: 11pt;
    }
  </style>
  </head>
<body>
  {% load tz %}
      <!-- <h3>{{ site_settings.teamname|default:"Team" }} Update - {% now "m-d-Y" %}</h3> -->
        {% for incident in incidents %}
        <div class="incident">
            <div><span class="title">Issue Date:</span> {{ incident.date_created }}</div>
            <div><span class="title">Issue Title:</span> {{ incident.headline }}</div>
            <div><span class="title">Owner:</span> {{ incident.user_created.first_name }} {{ incident.user_created.last_name }}</div>
            <div><span class="title">Status:</span> {{ incident.status }}</div>
            <pre>{{ incident.log }}</pre>
            <hr>
        </div>
        {% endfor %}

    {% if providers_with_emails %}
      <h3>Scheduled Maintenance</h3>
      {% for provider, emails in providers_with_emails %}
        <table cellpadding="0" cellspacing="0" role="presentation" width="100%">
          <tr>
            <th colspan="7"><strong>{{ provider.name }}</strong></th> 
          </tr>
          <tr>
            <th>Name</th>
            <th>Circuit ID(s)</th>
            <th>Mtc#</th>
            <th>Status</th>
            <th>Impact</th>
            <th>Start Time</th>
            <th>End Time</th>
          </tr>
          {% for circuit in emails %}
            <tr>
              <td>
                {% for cktname in circuit.circuits.all %}
                  {{ cktname.name }}<br>
                {% endfor %}
              </td>
              <td>
                {% for cktid in circuit.circuits.all %}
                  {{ cktid.cktid }}<br>
                {% endfor %}
              </td>
              <td>{{ circuit.mtc_id }}</td>
              <td>{{ circuit.status }}</td>
              <td>{{ circuit.impact }}</td>
              <td>{{ circuit.startdatetime }}</td>
              <td>{{ circuit.enddatetime }}</td>
            </tr>
          {% endfor %}
        </table><br>
      {% endfor %}
    {% endif %}

    {% if advisories %}
      <h3>Cisco Field Notices</h3>
      <table cellpadding="0" cellspacing="0" role="presentation" width="100%">
        <tr>
          <th>Title</th>
          <th>Impact</th>
          <th>Description</th>
          <th>Date</th>
          <th>Owner</th>
          <th>Status</th>
        </tr>
        {% for advisory in advisories %}
          <tr>
            <td><a href="{{ advisory.url }}">{{ advisory.title_short }}</a></td>
            <td>
              <span class="badge
                        {% if advisory.impact_rating == 'Critical' %}bg-danger
                        {% elif advisory.impact_rating == 'High' %}bg-warning text-light
                        {% else %}bg-secondary{% endif %}">
                        {{ advisory.impact_rating|capfirst }}
              </span>
            </td>
            {% if advisory.status != 'Open' %}
            <td class="text-truncate" style="white-space: normal; max-width: 550px; ">
              <small class="text-muted d-block" style="max-width:850px;">{{ advisory.note|truncatechars:300 }}</small>
            </td>
            {% else %}
            <td class="text-truncate" style="white-space: normal; max-width: 550px; ">
              <small class="text-muted d-block" style="max-width:850px;">{{ advisory.description|truncatechars:300 }}</small>
            </td>
            {% endif %}
            <td>{{ advisory.date }}</td>
            <td>{{ advisory.owner.first_name }} {{ advisory.owner.last_name }}</td>
            <td>
              <span class="badge
                    {% if advisory.status == 'Open' %} bg-primary
                    {% elif advisory.status == 'Impacted' %} bg-danger
                    {% elif advisory.status == 'No Impact' %} bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ advisory.status|capfirst }}
              </span>
            </td>
          </tr>
        {% endfor %}
      </table><br>
      <div class="spacer"></div>
    {% endif %}

    {% if certs %}
      <h3>Certificate Expirations</h3>
      <table cellpadding="0" cellspacing="0" role="presentation" width="100%">
        <tr>
          <th>Provider</th>
          <th>Certificate Name</th>
          <th>Common Name</th>
          <th>Expiration Date</th>
        </tr>
        {% for cert in certs %}
          <tr>
            <td>{{ cert.provider }}</td>
            <td>{{ cert.cert_name }}</td>
            <td>{{ cert.common_name }}</td>
            <td>{{ cert.expire_date }}</td>
          </tr>
        {% endfor %}
      </table><br>
      <div class="spacer"></div>
    {% endif %}

    {% if svc_acts %}
      <h3>Service Account Expirations</h3>
      <table cellpadding="0" cellspacing="0" role="presentation" width="100%">
        <tr>
          <th>Service Account</th>
          <th>Date</th>
        </tr>
        {% for svc_act in svc_acts %}
          <tr>
            <td>{{ svc_act.svc_act }}</td>
            <td>{{ svc_act.expire_date }}</td>
          </tr>
        {% endfor %}
      </table><br>
    {% endif %}
</body>
</html>