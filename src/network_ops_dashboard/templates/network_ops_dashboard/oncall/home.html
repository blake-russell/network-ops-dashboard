{% extends 'network_ops_dashboard/base.html' %}
{% load app_tags %}
{% block content %}

<!DOCTYPE html>
<html>
<head>
  {% block title %}
    {% if site_settings %}
      <title>{{ site_settings.teamname }} On-Call Report</title>
    {% else %}
      <title>Company Name - On-Call Report</title>
    {% endif %}
  {% endblock %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .edit-mode textarea { width: 100%; }
    .hide-on-print { display: inline; }
    .print-mode .hide-on-print { display: none; }
    textarea.edit-log { 
      width: 50%;
      height: 200px;
      resize: veritical;
      font-family: Calibri, sans-serif;
      font-size: 11pt;
    }
    .incident {
      margin-bottom: 30px;
    }
    hr {
      border: 1px solid #ccc;
    }
    .title {
      font-weight: bold;
      color: red;
    }
    pre {
      background: none;
      border: none;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: Calibri, sans-serif;
      font-size: 11pt;
    }
    strong {
      font-family: Calibri, sans-serif;
      font-size: 11pt;
    }
  </style>
</head>
<body>

<h3 id="currentDate"></h3>
<!-- <button onclick="togglePrintMode()" class="hide-on-print">üñ®Ô∏è Print/Copy Mode</button> &nbsp; -->
<a href="{% url 'oncall_add_incident' %}" class="btn btn-success mb-3 hide-on-print">‚ûï Add Incident</a> &nbsp;
<button onclick="redirectToPrint()" class="btn btn-outline-primary btn-sm">üñ®Ô∏è Print/Copy Mode</button> &nbsp;
<a href="{% url 'oncall_incident_log' %}" class="btn btn-outline-secondary btn-sm hide-on-print">üìú Incident Log</a> &nbsp;
<!-- <button onclick="copyCleanIncidentContent()" class="btn btn-outline-primary btn-sm">üìã Copy for Email</button> -->

{% if request.user.is_staff %}
<button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#oncallEmailModal">
  ‚úâ Email Settings
</button>

<div class="modal fade" id="oncallEmailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="oncall-email-form">
      <div class="modal-header">
        <h5 class="modal-title">On-Call Daily Email</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="oc-enable"
                 {% if feature_flags.enable_oncall_email %}checked{% endif %}>
          <label class="form-check-label" for="oc-enable">Enable daily email</label>
        </div>

        <div class="mb-3">
          <label class="form-label">Recipients (comma or semicolon separated)</label>
          <input type="text" class="form-control" id="oc-recipients"
                 value="{{ feature_flags.oncall_email_to|default:'' }}">
        </div>

        <div class="mb-1">
          <label class="form-label">Send time</label>
          <input type="time" class="form-control" id="oc-time"
                 value="{% if feature_flags.oncall_email_time %}{{ feature_flags.oncall_email_time|time:'H:i' }}{% endif %}">
          <div class="form-text">Server local time</div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById('oncall-email-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const recipients = document.getElementById('oc-recipients').value || '';
    const send_time = document.getElementById('oc-time').value || '';
    const enabled = document.getElementById('oc-enable').checked;
  
    // Save address/time first
    const fd1 = new FormData();
    fd1.append('recipients', recipients);
    fd1.append('send_time', send_time);
    fd1.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    await fetch("{% url 'oncall_email_save' %}", { method: 'POST', body: fd1 });
  
    // Toggle (also creates/removes cron)
    const fd2 = new FormData();
    fd2.append('enabled', enabled ? 'true' : 'false');
    fd2.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    await fetch("{% url 'oncall_email_toggle' %}", { method: 'POST', body: fd2 });
  
    window.location.reload();
  });
  </script>

  <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#oncallDisplayModal">
    ‚öô On-Call Settings
  </button>
  
  <div class="modal fade" id="oncallDisplayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form class="modal-content" id="oncall-display-form">
        <div class="modal-header">
          <h5 class="modal-title">On-Call Display Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Circuit Maintenance ‚Äì Include tags (any match)</label>
            <select name="circuit_tags" id="oc-tags" class="form-select" multiple size="8">
              {% for t in tags %}
                <option value="{{ t.pk }}" {% if t in oncall_settings.circuit_tags.all %}selected{% endif %}>
                  {{ t.name }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Leave empty to include all circuit maintenance.</div>
          </div>
  
          <hr>
  
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="show_scheduled_maintenance" id="oc-sm"
                       {% if oncall_settings.show_scheduled_maintenance %}checked{% endif %}>
                <label class="form-check-label" for="oc-sm">Show Scheduled Maintenance</label>
              </div>
            </div>
  
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="show_field_advisories" id="oc-fa"
                       {% if oncall_settings.show_field_advisories %}checked{% endif %}>
                <label class="form-check-label" for="oc-fa">Show Field Advisories</label>
              </div>
            </div>
  
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="show_cert_expiry" id="oc-ce"
                       {% if oncall_settings.show_cert_expiry %}checked{% endif %}>
                <label class="form-check-label" for="oc-ce">Show Certificate Expirations</label>
              </div>
            </div>
  
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="show_svcacct_expiry" id="oc-sa"
                       {% if oncall_settings.show_svcacct_expiry %}checked{% endif %}>
                <label class="form-check-label" for="oc-sa">Show Service Account Expirations</label>
              </div>
            </div>
          </div>
        </div>

				<hr>
				
				<h6 class="mb-2">Incident Archiving</h6>
				<div class="row g-3 mb-3">
				<div class="col-md-4">
					<label class="form-label">Days to display</label>
					<input type="number" min="1" class="form-control" name="report_window_days"
						value="{{ oncall_settings.report_window_days|default:7 }}">
				</div>
				<div class="col-md-8 d-flex align-items-end">
					<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" name="show_closed_in_report" id="oc-closed"
							{% if oncall_settings.show_closed_in_report %}checked{% endif %}>
					<label class="form-check-label" for="oc-closed">Include closed incidents in report</label>
					</div>
				</div>
				</div>
				
				<h6 class="mb-2">Auto-Archive Closed Incidents</h6>
				<div class="form-check form-switch mb-3">
				<input class="form-check-input" type="checkbox" name="auto_archive_enabled" id="oc-arch-enabled"
						{% if oncall_settings.auto_archive_enabled %}checked{% endif %}>
				<label class="form-check-label" for="oc-arch-enabled">Enable auto-archive</label>
				</div>
				
				<div class="row g-3 mb-1">
				<div class="col-md-5">
					<label class="form-label">Frequency</label>
					<select class="form-select" name="auto_archive_frequency" id="oc-arch-freq">
					<option value="daily"  {% if oncall_settings.auto_archive_frequency == 'daily' %}selected{% endif %}>Daily</option>
					<option value="weekly" {% if oncall_settings.auto_archive_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
					</select>
				</div>
				<div class="col-md-4">
					<label class="form-label">Time</label>
					<input type="time" class="form-control" name="auto_archive_time"
						value="{{ oncall_settings.auto_archive_time|default:'08:30' }}">
					<div class="form-text">Server local time</div>
				</div>
				<div class="col-md-3" id="oc-arch-weekday-wrap"
					{% if oncall_settings.auto_archive_frequency != 'weekly' %}style="display:none"{% endif %}>
					<label class="form-label">Weekday</label>
					<select class="form-select" name="auto_archive_weekday">
					{% for day in days %}
						<option value="{{ forloop.counter0 }}"
								{% if oncall_settings.auto_archive_weekday == forloop.counter0 %}selected{% endif %}>
						{{ day }}
						</option>
					{% endfor %}
					</select>
				</div>
			  </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
  
  <script>
    document.getElementById('oncall-display-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);
      fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      const sel = document.getElementById('oc-tags');
      if (sel) {
        [...sel.selectedOptions].forEach(o => fd.append('circuit_tags', o.value));
      }
      await fetch("{% url 'oncall_display_save' %}", { method: 'POST', body: fd });
      window.location.reload();
    });
  </script>

  <script>
    (function(){
      const freq = document.getElementById('oc-arch-freq');
      const wrap = document.getElementById('oc-arch-weekday-wrap');
      if (freq && wrap) {
      const sync = () => { wrap.style.display = (freq.value === 'weekly') ? '' : 'none'; };
      freq.addEventListener('change', sync);
      sync();
      }
    })();
  </script>
  
<hr>

<div id="incident-print-section">
  {% for incident in incidents %}
    <div class="incident" data-id="{{ incident.id }}">
      <strong class="hide-on-print">Created By: {{ incident.user_created.first_name }} {{ incident.user_created.last_name }}</strong><br>
      <strong class="hide-on-print"><b>Modified By:</b> {{ incident.user_modified.first_name }} {{ incident.user_modified.last_name }}</strong> <br>
      <strong style="color:red;">Issue Date:</strong> <strong> {{ incident.date_created }} </strong><br>
      <strong style="color:red;">Issue Title:</strong> <strong> {{ incident.headline }} </strong><br>
      <strong style="color:red;">Status:</strong> <strong> {{ incident.status }} </strong><br>
      <div class="log-content">
        <pre>{{ incident.log }}</pre>
        <textarea class="edit-log hide-on-print" style="display:none;">{{ incident.log }}</textarea>
        <button class="edit-button hide-on-print">‚úèÔ∏è Edit</button>
        <button class="save-button hide-on-print" style="display:none;">üíæ Save</button>
        <form method="POST" action="{% url 'oncall_close_incident' incident.id %}" onsubmit="return confirm('Are you sure you want to close this incident?');">
            {% csrf_token %}
            {% if incident.status == 'Open' %}
              <button type="submit" class="close-button btn btn-danger btn-sm hide-on-print">‚úñ Close</button>
            {% elif incident.status == 'Closed' %}
              <button type="submit" class="close-button btn btn-danger btn-sm hide-on-print">‚úñ Archive</button>
            {% endif %}
        </form>

      </div>
      <hr>
    </div>
  {% endfor %}
  
  {% if providers_with_emails %}
    <h4><u>Scheduled Maintenance</u></h4>
		{% for provider, emails in providers_with_emails %}
			<table class="table table-hover" id="my-table">
				<tr>
					<th colspan="8"><strong>{{ provider.name }}</strong></th> 
				</tr>
				<tr>
					<th>Name</th>
					<th>Circuit ID(s)</th>
					<th>Mtc#</th>
					<th>Status</th>
					<th>Impact</th>
					<th>Start Time</th>
					<th>End Time</th>
				</tr>
				{% for circuit in emails %}
					<tr class="table-light">
						<td>{% for cktname in circuit.circuits.all %} {{ cktname.name }}<br>{% endfor %}</td>
						<td>{% for cktid in circuit.circuits.all %} {{ cktid.cktid }}<br>{% endfor %}</td>
						<td>{{ circuit.mtc_id }}</td>
						<td>{{ circuit.status }}</td>
						<td>{{ circuit.impact }}</td>
						<td>{{ circuit.startdatetime }}</td>
						<td>{{ circuit.enddatetime }}</td>
					</tr>
				{% endfor %}
			</table><br>
		{% endfor %}
  {% endif %}

	{% if advisories %}
	<h5><u>Field Notices</u></h5>
	<table class="table table-hover" id="my-table">
		<tr>
		<th>Title</th>
		<th>Impact Rating Name</th>
		<th>Description</th>
		<th>Date</th>
		</tr>
		{% for advisory in advisories %}
		<tr class="table-light">
		<td><a href="{{ advisory.url }}" target="_new">{{ advisory.title_short }}</a></td>
		<td>{{ advisory.impact_rating }}</td> 
		<td style="word-wrap; break-word; white-space: normal;">{{ advisory.description }}</td>
		<td>{{ advisory.date }}</td>
		</tr> 
		{% endfor %}
	</table>
	{% endif %}
	
	{% if certs %}
	<br><h5><u>Certificate Expirations</u></h5>
	<table class="table table-hover" id="my-table">
		<tr>
		<th>Provider</th>
		<th>Certificate Name</th>
		<th>Common Name</th>
		<th>Expiration Date</th>
		</tr>
		{% for cert in certs %}
		<tr class="table-light">
		<td>{{ cert.provider }}</td>
		<td>{{ cert.cert_name }}</td>
		<td>{{ cert.common_name }}</td>
		<td>{{ cert.expire_date }}</td>
		</tr>
		{% endfor %}
	</table>
	{% endif %}
	
	{% if svc_acts %}
	<br><h5><u>Service Account Expirations</u></h5>
	<table class="table table-hover" id="my-table">
		<tr>
		<th>Service Account</th>
		<th>Date</th>
		</tr>
		{% for svc_act in svc_acts %}
		<tr class="table-light">
		<td>{{ svc_act.svc_act }}</td>
		<td>{{ svc_act.expire_date }}</td>
		</tr>
		{% endfor %}
	</table>
	{% endif %}

</div>

<script>
$(document).ready(function() {
  $('.edit-button').click(function() {
    let container = $(this).closest('.incident');
    container.find('pre').hide();
    container.find('.edit-log').show();
    $(this).hide();
    container.find('.save-button').show();
    container.find('.close-button').hide();
  });

  $('.save-button').click(function() {
    let container = $(this).closest('.incident');
    let id = container.data('id');
    let log = container.find('.edit-log').val();
    $.post(`/oncall/update/${id}/`, {log: log, csrfmiddlewaretoken: '{{ csrf_token }}'}, function(response) {
      if (response.success) {
        container.find('pre').text(log).show();
        container.find('.edit-log').hide();
        container.find('.save-button').hide();
        container.find('.edit-button').show();
        container.find('.close-button').show();
      }
    });
  });
});
</script>

{% if site_settings %}
  <script>
    const dateElement = document.getElementById("currentDate");
    const currentDate = new Date().toLocaleDateString(); 
    dateElement.textContent = "{{ site_settings.teamname }} Update - " + currentDate;
  </script>
{% else %}
  <script>
    const dateElement = document.getElementById("currentDate");
    const currentDate = new Date().toLocaleDateString(); 
    dateElement.textContent = "Team Name Update - " + currentDate;
  </script>
{% endif %}



<script>
  function redirectToPrint() {
    window.location.href = "{% url 'oncall_incident_print' %}";
  }
</script>

</body>
</html>

{% endblock %}