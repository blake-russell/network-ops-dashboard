{% extends 'network_ops_dashboard/base.html' %}
{% block content %}
<h3>Network Inventory</h3>

<form id="filters" class="row g-2 align-items-end mb-3">
  <div class="col-sm-3">
    <label class="form-label">Site</label>
    <select name="site" class="form-select" id="f-site">
      <option value="">All</option>
      {% for s in site_choices %}
        <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-3">
    <label class="form-label">Device type (Platform)</label>
    <select name="platform" class="form-select" id="f-platform">
      <option value="">All</option>
      {% for p in platform_choices %}
        <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Tag</label>
    <select name="tag" class="form-select" id="f-tag">
      <option value="">All</option>
      {% for t in tag_choices %}
        <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-3">
    <label class="form-label">Search</label>
    <input type="text" name="q" class="form-control" id="f-q" placeholder="name, serial, IP">
  </div>
  <div class="col-sm-1 d-grid">
    <button class="btn btn-primary" type="submit">Filter</button>
  </div>
  <div class="col-12 mt-1">
    <a href="#" id="reset-filters" class="btn btn-sm btn-outline-secondary">Reset</a>
    <a href="{% url 'inventory_add' %}" class="btn btn-sm btn-outline-primary">Add Network Device</a>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#discoverModal">
      ðŸ”Ž Discover Devices
    </button>
  </div>
</form>

<div class="table-responsive">
<table class="table table-hover table-sm mb-0" id="my-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Site</th>
      <th>Device</th>
      <th>Serial#</th>
      <th>IP Address (MGMT)</th>
      <th>Device Tags</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="inv-tbody">
    <tr><td colspan="7" class="text-muted">Loadingâ€¦</td></tr>
  </tbody>
</table>
</div>


<!-- Discovery Modal -->
<div class="modal fade" id="discoverModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{% url 'inventory_discovery_start' %}">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Discover Devices</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Targets</label>
          <textarea name="targets" class="form-control" rows="3"
            placeholder="10.0.0.0/24&#10;host1.example.com&#10;10.0.0.5-10.0.0.25"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Discovery Method</label>
          <select name="scan_kind" class="form-select">
            <!-- <option value="icmp" selected>ICMP ping</option> -->
            <option value="snmp">SNMP</option>
            <option value="ssh">SSH</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">SNMP Community</label>
          <input type="text" name="snmp_community" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">SSH Credential</label>
          {{ discovery_form.credential }}
          <br>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Timeout</label>
            <input type="number" name="timeout" min="1" value="5" class="form-control">
          </div>
          <div class="col-6 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="verify_ssl" id="verifyssl">
              <label for="verifyssl" class="form-check-label">Verify SSL</label>
            </div>
          </div>
        </div>

        {% if discovery_form_errors %}
          <div class="alert alert-danger mt-3">
            {{ discovery_form_errors }}
          </div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Start Discovery</button>
      </div>
    </form>
  </div>
</div>

<!-- automatically open modal if there are post/form errors -->
{% if discovery_form_errors %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var modal = new bootstrap.Modal(document.getElementById("discoverModal"));
    modal.show();
  });
</script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const methodSelect = document.querySelector("select[name='scan_kind']");
    const snmpField = document.querySelector("input[name='snmp_community']");
    const sshField = document.querySelector("select[name='credential'], input[name='credential']");
  
    function toggleFields() {
      if (methodSelect.value === "snmp") {
        snmpField.removeAttribute("disabled");
        sshField.setAttribute("disabled", "disabled");
        sshField.value = "";
      } else if (methodSelect.value === "ssh") {
        sshField.removeAttribute("disabled");
        snmpField.setAttribute("disabled", "disabled");
        snmpField.value = "";
      } else {
        // default: both enabled (if adding additional discovery methods later)
        snmpField.removeAttribute("disabled");
        sshField.removeAttribute("disabled");
      }
    }
  
    methodSelect.addEventListener("change", toggleFields);
    toggleFields();
  });
  </script>

<script>
(function(){
  const tbody = document.getElementById('inv-tbody');
  const form  = document.getElementById('filters');
  const siteEl = document.getElementById('f-site');
  const platEl = document.getElementById('f-platform');
  const tagEl  = document.getElementById('f-tag');
  const qEl    = document.getElementById('f-q');
  const resetBtn = document.getElementById('reset-filters');

  let typingTimer;
  const debounce = (fn, wait=300) => {
    return (...args) => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => fn.apply(this, args), wait);
    };
  };

  function buildQuery() {
    const p = new URLSearchParams();
    if (siteEl.value) p.set('site', siteEl.value);
    if (platEl.value) p.set('platform', platEl.value);
    if (tagEl.value)  p.set('tag', tagEl.value);
    if (qEl.value.trim()) p.set('q', qEl.value.trim());
    return p.toString();
  }

  async function fetchRows() {
    tbody.innerHTML = `<tr><td colspan="7" class="text-muted">Loadingâ€¦</td></tr>`;
    const qs = buildQuery();
    const url = `{% url 'inventory_data' %}` + (qs ? `?${qs}` : '');
    const res = await fetch(url, {headers: {'X-Requested-With':'XMLHttpRequest'}});
    const data = await res.json();
    renderRows(data.rows || []);
  }

  function renderRows(rows) {
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-muted">No results.</td></tr>`;
      return;
    }
    const html = rows.map(r => `
      <tr class="table-light">
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.site)}</td>
        <td>${escapeHtml(r.platform)}</td>
        <td>${escapeHtml(r.serial_number)}</td>
        <td>${escapeHtml(r.ipaddress_mgmt)}</td>
        <td>${(r.tags || []).map(t => escapeHtml(t)).join('<br>')}</td>
        <td><a href="${buildEditUrl(r.pk)}" class="btn btn-sm btn-outline-secondary">Edit</a></td>
      </tr>
    `).join('');
    tbody.innerHTML = html;
  }

  function buildEditUrl(pk) {
    return "{% url 'inventory_edit' 0 %}".replace("0", String(pk));
  }

  function escapeHtml(s) {
    return (s ?? '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    fetchRows();
  });

  qEl.addEventListener('input', debounce(fetchRows, 300));

  siteEl.addEventListener('change', fetchRows);
  platEl.addEventListener('change', fetchRows);
  tagEl.addEventListener('change', fetchRows);

  // Reset
  resetBtn.addEventListener('click', (e) => {
    e.preventDefault();
    siteEl.value = '';
    platEl.value = '';
    tagEl.value = '';
    qEl.value = '';
    fetchRows();
  });

  // Initial load
  fetchRows();
})();
</script>
{% endblock %}