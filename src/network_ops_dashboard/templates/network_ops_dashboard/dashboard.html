{% extends 'network_ops_dashboard/base.html' %}
{% load app_tags %}
{% block content %}

{% if site_settings %}
  <h3>{{ site_settings.teamname }} Team Dashboard</h3>
{% else %}
  <div class="alert alert-dismissible alert-warning">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <h4 class="alert-heading">Warning!</h4>
    <p class="mb-0">No SiteSecrets.objects() object founds. Go to the <a href="/admin" class="alert-link">admin</a> panel and configure one.</p>
  </div>
{% endif %}

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Card 1 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">

        <div class="card-header text-center">
          <strong>Notifications</strong>
        </div>

        <div class="card-body">
          {% if new_svcacts %}
          <table class="table table-borderless mb-0">
              <strong>Service Account Password Expiry</strong>
            <tbody>
              {% for svc_act in new_svcacts %}
              <tr>
                <td><b>{{ svc_act.svc_act }}</b></td>
                <td class="text-right"><small class="text-muted">{{ svc_act.expire_date }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>
          {% endif %}

          {% if new_certalerts %}
          <table class="table table-borderless mb-0">
              <strong>Certificate Expiry</strong>
            <tbody>
              {% for certs in new_certalerts %}
              <tr>
                <td><b>{{ certs.common_name }}</b></td>
                <td class="text-right"><small class="text-muted">{{ certs.expire_date }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>
          {% endif %}

          {% if new_ciscoadvisory %}
          <table class="table table-borderless mb-0">
              <strong>Cisco Field Advisory</strong>
            <tbody>
              {% for advisory in new_ciscoadvisory %}
              <tr>
                <td><a href="{{ advisory.url }}" target="_new"><b>{{ advisory.title_short }}</a></b></td>
                <td class="text-right"><small class="text-muted">{{ advisory.impact_rating }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- Card 2 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        
        <div class="card-header text-center">
          <strong>VPN Stats (5m interval)</strong>
        </div>

        <div class="card-body">
          <table class="table table-borderless mb-0">
            <tbody>
              <tr>
                <td>Device</b></td>
                <td class="text-right"><small class="text-muted">Users</small></td>
                <td class="text-right"><small class="text-muted">Load</small></td>
              </tr>
              {% for asa in asastats %}
              <tr>
                <td>{{ asa.name }}</b></td>
                <td class="text-right"><small class="text-muted">{{ asa.connected }}</small></td>
                <td class="text-right"><small class="text-muted">{{ asa.load }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>

        </div>
      </div>
    </div>
  
    <!-- Card 3 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>Recent Site Changes</strong>
          <div>
            <button class="btn btn-sm btn-outline-secondary" id="chg-prev" disabled>&larr;</button>
            <button class="btn btn-sm btn-outline-secondary" id="chg-next">&rarr;</button>
          </div>
        </div>
      <div class="card-body">
        <div id="changelog-container">{{ changelog_entries|json_script:"changelog-data" }}</div>
      </div>
    </div>
  </div>

<script>
  (function(){
    // Parse data safely from the script tag
    const changelogEntries = JSON.parse(document.getElementById('changelog-data').textContent) || [];
    const container = document.getElementById('changelog-container');
    const prevBtn = document.getElementById('chg-prev');
    const nextBtn = document.getElementById('chg-next');
    if (!container || !changelogEntries.length) return;
  
    let i = 0;
  
    function render() {
      const entry = changelogEntries[i];
      let html = `<h6 class="mb-2"><strong>${entry.version}</strong></h6><ul class="mb-0">`;
      for (const line of entry.changes) {
        html += `<li>${line}</li>`;
      }
      html += `</ul>`;
      container.innerHTML = html;
  
      prevBtn.disabled = (i === 0);
      nextBtn.disabled = (i === changelogEntries.length - 1);
    }
  
    prevBtn.addEventListener('click', () => { if (i > 0) { i--; render(); } });
    nextBtn.addEventListener('click', () => { if (i < changelogEntries.length - 1) { i++; render(); } });
  
    render();
  })();
</script>

<script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  });
</script>

{% endblock %}