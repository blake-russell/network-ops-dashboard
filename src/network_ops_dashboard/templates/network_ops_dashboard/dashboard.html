{% extends 'network_ops_dashboard/base.html' %}
{% block content %}

<style>
  .accordion-button { padding-top:.4rem; padding-bottom:.4rem; }
</style>

<div class="d-flex align-items-center">
  <h3 class="me-auto">
    {% if site_settings %}{{ site_settings.teamname }} Team Dashboard{% else %}Team Dashboard{% endif %}
  </h3>
  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#customizeModal">
    ⚙ Customize
  </button>
</div>

<div class="container-fluid mt-4">
  <div id="card-grid" class="row" data-order='{{ visible_ids|json_script:"vis-ids" }}'>
    {% for cid in visible_ids %}
      {% if cid == "changelog" %}
      <div class="col-md-4 mb-4 dashboard-card" data-card-id="changelog">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>{% for t in all_cards %} {% if t.id == cid %} {{ t.title }} {% endif %} {% endfor %}</strong>
            <div>
              <button class="btn btn-sm btn-outline-secondary" id="chg-prev" disabled>&larr;</button>
              <button class="btn btn-sm btn-outline-secondary" id="chg-next">&rarr;</button>
            </div>
          </div>
          <div class="card-body">
            <div id="changelog-container">{{ changelog_entries|json_script:"changelog-data" }}</div>
          </div>
        </div>
      </div>
      {% elif cid == "notifications" %}
        {% include 'network_ops_dashboard/cards.html' %}
      {% elif cid == "asa_vpn_stats" %}
        <div class="col-md-4 mb-4 dashboard-card" data-card-id="asa_vpn_stats">
          <div class="card h-100">
            <div class="card-header text-center"><strong>{% for t in all_cards %} {% if t.id == cid %} {{ t.title }} {% endif %} {% endfor %}</strong></div>
            <div class="card-body"
            hx-get="{% url 'asavpn_card_partial_htmx' %}" 
            hx-trigger="load, every 75s" 
            hx-swap="innerHTML">
              {% include 'network_ops_dashboard/asavpn/cards.html' with card_asa_vpn_stats=card_asa_vpn_stats %}
            </div>
          </div>
        </div>
      {% elif cid == "enable_sdwan_cards" %}
        {% if feature_flags.enable_sdwan_cards %}
          <div class="col-md-4 mb-4 dashboard-card" data-card-id="enable_sdwan_cards">
            <div class="card h-100">
              <div class="card-header text-center"><strong>{% for t in all_cards %} {% if t.id == cid %} {{ t.title }} {% endif %} {% endfor %}</strong></div>
                <div class="card-body"
                hx-get="{% url 'sdwan_card_partial_htmx' %}" 
                hx-trigger="load, every 75s" 
                hx-swap="innerHTML">
                  {% include 'network_ops_dashboard/sdwan/vmanage/cards.html' with sdwan_top_sites=sdwan_top_sites %}
                </div>
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</div> 

<!-- Customize modal -->
<div class="modal fade" id="customizeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="prefs-form">
      <div class="modal-header">
        <h5 class="modal-title">Customize dashboard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p class="text-muted small mb-2">Drag to reorder. Uncheck to hide.</p>

        <ul id="card-list" class="list-group">
          {% for c in all_cards %}
          <li class="list-group-item d-flex justify-content-between align-items-center"
              data-card-id="{{ c.id }}"
              {% if c.feature_off %}style="opacity:.5;"{% endif %}>
            <span class="handle me-2">⠿</span>
            <span class="flex-grow-1">
              {{ c.title }}
              {% if c.required %}
                <span class="badge bg-secondary ms-2">required</span>
              {% endif %}
              {% if c.feature_off %}
                <span class="badge bg-warning text-dark ms-2">feature disabled</span>
              {% endif %}
            </span>
            <div class="form-check form-switch">
              <input class="form-check-input card-toggle"
                     type="checkbox"
                     {% if c.id not in hidden_ids %}checked{% endif %}
                     {% if c.required or c.feature_off %}disabled{% endif %}>
            </div>
          </li>
          {% endfor %}
        </ul>

        {% if request.user.is_staff %}
        <hr>
        
        <div class="accordion accordion-flush" id="cfgAccordion">
        
          <!-- ASA VPN Stats -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="asaHeading">
              <button class="accordion-button collapsed py-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#asaCollapse"
                      aria-expanded="false" aria-controls="asaCollapse">
                <strong>ASA VPN Stats</strong>
              </button>
            </h2>
            <div id="asaCollapse" class="accordion-collapse collapse"
                 aria-labelledby="asaHeading" data-bs-parent="#cfgAccordion">
              <div class="accordion-body">
                <div class="row g-2 align-items-center">
                  <div class="col-auto">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="ff-asa"
                             {% if feature_flags.enable_asa_vpn_stats %}checked{% endif %}>
                      <label class="form-check-label" for="ff-asa">Enable</label>
                    </div>
                  </div>
                  <div class="col-auto">
                    <input type="number" class="form-control" id="ff-asa-interval" min="1" max="60"
                           value="{{ feature_flags.asa_vpn_interval_minutes }}">
                  </div>
                  <div class="col-auto">
                    <label for="ff-asa-interval" class="col-form-label">Interval (minutes)</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <!-- Cisco SD-WAN Stats -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="sdwanHeading">
              <button class="accordion-button collapsed py-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#sdwanCollapse"
                      aria-expanded="false" aria-controls="sdwanCollapse">
                <strong>Cisco SD-WAN Stats</strong>
              </button>
            </h2>
            <div id="sdwanCollapse" class="accordion-collapse collapse"
                 aria-labelledby="sdwanHeading" data-bs-parent="#cfgAccordion">
              <div class="accordion-body">
                <div class="row g-2 align-items-center">
                  <div class="col-auto">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="ff-sdwan"
                             {% if feature_flags.enable_sdwan_cards %}checked{% endif %}>
                      <label class="form-check-label" for="ff-sdwan">Enable</label>
                    </div>
                  </div>
                  <div class="col-auto">
                    <input type="number" class="form-control" id="ff-sdwan-interval" min="1" max="60"
                           value="{{ feature_flags.sdwan_interval_minutes }}">
                  </div>
                  <div class="col-auto">
                    <label for="ff-sdwan-interval" class="col-form-label">Interval (minutes)</label>
                  </div>
                </div>
        
                <div class="row g-3 mt-2">
                  <div class="col-md-6">
                    <label class="form-label">{{ sdwan_settings_form.host.label }}</label>
                    {{ sdwan_settings_form.host }}
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">{{ sdwan_settings_form.purge_path_stats.label }}</label>
                    {{ sdwan_settings_form.purge_path_stats }}
                  </div>
                </div>
        
                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <label class="form-label">{{ sdwan_settings_form.top_n.label }}</label>
                    {{ sdwan_settings_form.top_n }}
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">{{ sdwan_settings_form.last_n.label }}</label>
                    {{ sdwan_settings_form.last_n }}
                  </div>
                </div>
        
                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <label class="form-label">{{ sdwan_settings_form.verify_ssl.label }}</label>
                    {{ sdwan_settings_form.verify_ssl }}
                  </div>
                  <div class="col-md-6"><!-- spare slot --></div>
                </div>
        
              </div>
            </div>
          </div>
        
        </div>
        {% endif %}
        

        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- End of Customize Modal -->

<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  // Drag in modal
  const listEl = document.getElementById('card-list');
  new Sortable(listEl, { handle: '.handle', animation: 150 });

  document.getElementById('prefs-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1) Save per-user layout prefs
    const items = [...document.querySelectorAll('#card-list li')];
    const order = items.map(li => li.dataset.cardId);
    const hidden = items.filter(li => !li.querySelector('.card-toggle').checked)
                        .map(li => li.dataset.cardId);
    await fetch("{% url 'dashboard_save_prefs' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
      body: JSON.stringify({ order, hidden })
    });

    // 2) Staff-only global settings
    {% if request.user.is_staff %}
    // ASA toggles
      const ffAsa = document.getElementById('ff-asa');
      const intervalEl = document.getElementById('ff-asa-interval');
      if (intervalEl) {
        const minutes = Math.max(parseInt(intervalEl.value || '5', 10), 1);
        const fd1 = new FormData();
        fd1.append('minutes', minutes.toString());
        fd1.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        await fetch("{% url 'dashboard_set_asa_vpn_interval' %}", { method: 'POST', body: fd1 });
      }
      if (ffAsa) {
        const fd2 = new FormData();
        fd2.append('enabled', ffAsa.checked ? 'true' : 'false');
        fd2.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        await fetch("{% url 'dashboard_toggle_asa_vpn_stats' %}", { method: 'POST', body: fd2 });
      }

    // SD-WAN toggles
      const fdSdwan = new FormData();
      const enabled_sdwan = document.getElementById('ff-sdwan')?.checked;
      const sdwan_interval = document.getElementById('ff-sdwan-interval');

      // toggles FeatureFlags.enable_sdwan_cards and SdwanSettings.card_enabled
      fdSdwan.append('enabled_sdwan', enabled_sdwan ? 'true' : 'false');
      fdSdwan.append('sdwan_interval', sdwan_interval.value);
      fdSdwan.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      // Pull values from the rendered form fields by name
      const hostSel = document.querySelector('select[name="host"]');
      if (hostSel && hostSel.value) fdSdwan.append('host', hostSel.value);
      const purgePath = document.querySelector('input[name="purge_path_stats"]');
      if (purgePath && purgePath.value) fdSdwan.append('purge_path_stats', purgePath.value);
      const topNEl = document.querySelector('input[name="top_n"]');
      if (topNEl && topNEl.value) fdSdwan.append('top_n', topNEl.value);
      const lastNEl = document.querySelector('input[name="last_n"]');
      if (lastNEl && lastNEl.value) fdSdwan.append('last_n', lastNEl.value);
      const verifySel = document.querySelector('input[name="verify_ssl"]');
      if (verifySel && verifySel.checked) fdSdwan.append('verify_ssl', 'on');
      await fetch("{% url 'dashboard_sdwan_settings_save' %}", { method: 'POST', body: fdSdwan });

    {% endif %}

  window.location.reload();
});

  (function(){
    const dataTag = document.getElementById('changelog-data');
    if (!dataTag) return;
    const changelogEntries = JSON.parse(dataTag.textContent) || [];
    const container = document.getElementById('changelog-container');
    const prevBtn = document.getElementById('chg-prev');
    const nextBtn = document.getElementById('chg-next');
    let i = 0;
    function render() {
      const entry = changelogEntries[i];
      let html = `<h6 class="mb-2"><strong>${entry.version}</strong></h6><ul class="mb-0">`;
      for (const line of entry.changes) html += `<li>${line}</li>`;
      html += `</ul>`;
      container.innerHTML = html;
      if (prevBtn) prevBtn.disabled = (i === 0);
      if (nextBtn) nextBtn.disabled = (i === changelogEntries.length - 1);
    }
    if (prevBtn) prevBtn.addEventListener('click', () => { if (i > 0) { i--; render(); } });
    if (nextBtn) nextBtn.addEventListener('click', () => { if (i < changelogEntries.length - 1) { i++; render(); } });
    render();
  })();
</script>
{% endblock %}