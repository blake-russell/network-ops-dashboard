{% extends 'network_ops_dashboard/base.html' %}
{% load app_tags %}
{% block content %}

{% if site_settings %}
  <h3>{{ site_settings.teamname }} Team Dashboard</h3>
{% else %}
  <div class="alert alert-dismissible alert-warning">
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <h4 class="alert-heading">Warning!</h4>
    <p class="mb-0">No SiteSecrets.objects() object founds. Go to the <a href="/admin" class="alert-link">admin</a> panel and configure one.</p>
  </div>
{% endif %}

<div class="container-fluid mt-4">
  <div class="row">
    <!-- Card 1 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">

        <div class="card-header text-center">
          <strong>Notifications</strong>
        </div>

        <div class="card-body">
          <table class="table table-borderless mb-0">
              <strong>Service Account Password Expiry</strong>
            <tbody>
              {% for svc_act in new_svcacts %}
              <tr>
                <td><b>{{ svc_act.svc_act }}</b></td>
                <td class="text-right"><small class="text-muted">{{ svc_act.expire_date }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>

          <table class="table table-borderless mb-0">
              <strong>Certificate Expiry</strong>
            <tbody>
              {% for certs in new_certalerts %}
              <tr>
                <td><b>{{ certs.common_name }}</b></td>
                <td class="text-right"><small class="text-muted">{{ certs.expire_date }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>

          <table class="table table-borderless mb-0">
              <strong>Cisco Field Advisory</strong>
            <tbody>
              {% for advisory in new_ciscoadvisory %}
              <tr>
                <td><a href="{{ advisory.url }}" target="_new"><b>{{ advisory.title_short }}</a></b></td>
                <td class="text-right"><small class="text-muted">{{ advisory.impact_rating }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>

        </div>
      </div>
    </div>

    <!-- Card 2 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        
        <div class="card-header text-center">
          <strong>VPN Stats (5m interval)</strong>
        </div>

        <div class="card-body">
          <table class="table table-borderless mb-0">
            <tbody>
              <tr>
                <td>Device</b></td>
                <td class="text-right"><small class="text-muted">Users</small></td>
                <td class="text-right"><small class="text-muted">Load</small></td>
              </tr>
              {% for asa in asastats %}
              <tr>
                <td>{{ asa.name }}</b></td>
                <td class="text-right"><small class="text-muted">{{ asa.connected }}</small></td>
                <td class="text-right"><small class="text-muted">{{ asa.load }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table><br>

        </div>
      </div>
    </div>

    <!-- Card 3 -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <strong>Recent Site Changes</strong>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            {% for change in site_changes %}
            <div data-toggle="tooltip" data-placement="top" title="{{ change.comment }}">
               <li>{{ change.icon}}{{ change.comment_title }}</li>
            </div>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Card 4 -->
    <div class="card mb-3" id="recent-changes">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Recent Changes</strong>
      <div>
      <button class="btn btn-sm btn-outline-secondary" id="rc-prev" disabled>&larr;</button>
      <button class="btn btn-sm btn-outline-secondary" id="rc-next">&rarr;</button>
      </div>
    </div>
    <div class="card-body">
      {% if recent_changes %}
        {% for r in recent_changes %}
        <div class="rc-item" {% if not forloop.first %}style="display:none"{% endif %}>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">{{ r.name|default:r.tag }}</h5>
            <small class="text-muted">{{ r.published_at|date:"Y-m-d H:i" }}</small>
          </div>
        <div class="markdown-body">{{ r.html_body|safe }}</div>
          <div class="mt-2">
            <a href="{{ r.html_url }}" target="_blank" rel="noopener">View on GitHub</a>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <em>No recent releases yet.</em>
      {% endif %}
      </div>
    </div>

  </div>
</div>

<script>
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  });
</script>

<script>
(function(){
  const items = Array.from(document.querySelectorAll('#recent-changes .rc-item'));
  if (!items.length) return;
  let i = 0;
  const prev = document.getElementById('rc-prev');
  const next = document.getElementById('rc-next');

  function updateButtons(){
    prev.disabled = (i === 0);
    next.disabled = (i === items.length - 1);
  }
  function show(idx){
    items.forEach((el, k) => el.style.display = (k === idx ? '' : 'none'));
    i = idx; updateButtons();
  }
  prev.addEventListener('click', () => show(i - 1));
  next.addEventListener('click', () => show(i + 1));
  updateButtons();
})();
</script>

{% endblock %}