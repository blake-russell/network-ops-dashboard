{% extends 'network_ops_dashboard/base.html' %}
{% load app_tags %}
{% block content %}
<h3>Circuit Maintenance Report</h3>

{% if circuits_exist %}
  <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
    <a href="{% url 'circuitsmtc_update' %}" class="btn btn-sm btn-outline-primary">Process New Emails</a>
    <a href="{% url 'circuit' %}" class="btn btn-sm btn-outline-secondary">Circuits</a>
    <a href="{% url 'circuitprovider' %}" class="btn btn-sm btn-outline-secondary">Circuit Providers</a>
    <a href="{% url 'circuittag' %}" class="btn btn-sm btn-outline-secondary">Circuit Tags</a>
  </div>

  {# Filters #}
  <div class="card mb-3">
    <div class="card-body">
      <form id="filters" class="row g-2 align-items-end">
  
        <div class="col-md-3">
          <label class="form-label mb-0">Status</label>
          <select name="status" class="form-select form-select-sm">
            <option value="">Any</option>
            {% for s in status_choices %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>
  
        <div class="col-md-3">
          <label class="form-label mb-0">Tag</label>
          <select name="tag" class="form-select form-select-sm">
            <option value="">Any</option>
            {% for t in tag_choices %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>
  
        <div class="col-md-3">
          <label class="form-label mb-0">Search</label>
          <input type="text" class="form-control form-control-sm" name="q" placeholder="name or Mtc#">
        </div>
  
        <div class="col-12 mt-2">
          <button class="btn btn-sm btn-primary">Apply</button>
          <button class="btn btn-sm btn-outline-secondary" id="reset-filters" type="button">Reset</button>
        </div>
      </form>
    </div>
  </div>

  {# Results container (grouped by provider) #}
  <div id="results"></div>

{% else %}
  <div class="alert alert-warning">
    No circuits found. Please configure Providers and Circuits first.
  </div>
{% endif %}

<script>
(function(){
  const form = document.getElementById('filters');
  const resultsEl = document.getElementById('results');
  const resetBtn = document.getElementById('reset-filters');

  function getParams() {
    const fd = new FormData(form);
    // collect multi-selects explicitly
    const params = new URLSearchParams();
    for (const [k, v] of fd.entries()) {
      if (!v) continue;
      if (k === 'status' || k === 'tag') continue;
      params.append(k, v);
    }
    const statuses = [...form.querySelectorAll('select[name="status"] option:checked')].map(o => o.value);
    const tags = [...form.querySelectorAll('select[name="tag"] option:checked')].map(o => o.value);
    statuses.forEach(s => params.append('status', s));
    tags.forEach(t => params.append('tag', t));
    return params;
  }

  async function fetchRows() {
    const params = getParams();
    const resp = await fetch("{% url 'circuitsmtc_data' %}?" + params.toString());
    const data = await resp.json();
    render(data.rows || []);
  }

  function groupByProvider(rows) {
    const buckets = {};
    rows.forEach(r => {
      const p = r.provider || '(Unknown)';
      (buckets[p] = buckets[p] || []).push(r);
    });
    return buckets;
  }

  function esc(s){ return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function render(rows){
    const byProv = groupByProvider(rows);
    const providers = Object.keys(byProv).sort();
    if (!providers.length) {
      resultsEl.innerHTML = '<div class="text-muted">No results.</div>';
      return;
    }
    let html = '';
    providers.forEach(p => {
      html += `
        <div class="table-responsive">
        <table class="table table-hover table-sm mb-0" id="my-table">
          <tr><th colspan="9"><strong>${esc(p)}</strong></th></tr>
          <tr>
            <th>Name</th>
            <th>Circuit ID(s)</th>
            <th>Mtc#</th>
            <th>Status</th>
            <th>Impact</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Tags</th>
            <th>Actions</th>
          </tr>
      `;
      byProv[p].forEach(r => {
        const names = r.name_list.join('<br>');
        const ids = r.cktid_list.join('<br>');
        const tags = r.tags.join('<br>');
        const start = esc(r.startdatetime || '');
        const end = esc(r.enddatetime || '');
        const archiveCell = r.can_archive
          ? `<a href="{% url 'circuitsmtc_archive' 0 %}".replace('/0/', '/'+r.pk+'/')" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Archive this item?')">Archive</a>`
          : `<span class="text-muted" title="No permission">â€”</span>`;
        html += `
          <tr class="table-light">
            <td>${names || ''}</td>
            <td>${ids || ''}</td>
            <td>${esc(r.mtc_id)}</td>
            <td>${esc(r.status)}</td>
            <td>${esc(r.impact)}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${tags}</td>
            <td>${archiveCell}</td>
          </tr>
        `;
      });
      html += `</table></div><br>`;
    });
    resultsEl.innerHTML = html;
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    fetchRows();
  });

  resetBtn.addEventListener('click', () => {
    form.reset();
    // clear multi-selects
    form.querySelectorAll('select[multiple] option').forEach(o => o.selected = false);
    fetchRows();
  });

  // initial load
  fetchRows();
})();
</script>
{% endblock %}