{% extends 'network_ops_dashboard/base.html' %}
{% load app_tags %}
{% block content %}
<h3>Schedule Changes Report</h3>

<div class="d-flex align-items-center flex-wrap gap-2 mb-3">
  {% if settings_obj.changes_folder and settings_obj.extract_folder %}
    <a href="{% url 'changes_update' %}" class="btn btn-sm btn-outline-primary mb-0">Process New Emails</a>
  {% endif %}
  <a href="#" id="toggle-column-link" class="btn btn-sm btn-outline-secondary mb-0">Show Metadata</a>
  {% include 'network_ops_dashboard/partials/email_job_controls.html' %}
  {% if request.user.is_staff %}
    <button class="btn btn-sm btn-outline-dark ms-auto" data-bs-toggle="modal" data-bs-target="#changesSettingsModal">
      ⚙ Settings
    </button>
  {% endif %}
</div>

<form id="changes-filters" class="row g-2 align-items-end mb-3">
  <div class="col-sm-3">
    <label class="form-label">Location</label>
    <select name="location" id="f-location" class="form-select">
      <option value="">All</option>
      {% for loc in locations %}
      <option value="{{ loc }}">{{ loc }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-3">
    <label class="form-label">Team</label>
    <select name="team_name" id="f-team" class="form-select">
      <option value="">All</option>
      {% for t in teams %}
      <option value="{{ t }}">{{ t }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-3">
    <label class="form-label">Group</label>
    <select name="group" id="f-group" class="form-select">
      <option value="">All</option>
      {% for g in groups %}
      <option value="{{ g }}">{{ g }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Search</label>
    <input type="text" name="q" id="f-q" class="form-control" placeholder="summary, reason, id…">
  </div>
  <div class="col-sm-1 d-grid">
    <button class="btn btn-primary" type="submit">Filter</button>
  </div>
  <div class="col-12 mt-1">
    <a href="#" id="reset-filters" class="btn btn-sm btn-outline-secondary">Reset</a>
  </div>
</form>

<table class="table table-hover" id="my-table">
  <thead>
    <tr>
      <th>Change ID</th>
      <th>Location</th>
      <th>Team</th>
      <th>Group</th>
      <th>Class</th>
      <th>Start Time</th>
      <th>End Time</th>
      <th>Summary</th>
      <th class="hidden-column">Metadata</th>
    </tr>
  </thead>
  <tbody id="changes-tbody">
    <tr><td colspan="9" class="text-muted">Loading…</td></tr>
  </tbody>
</table>

{% if request.user.is_staff %}
  {# keep your existing settings modal block here unchanged #}
{% endif %}

<style>.hidden-column { display: none; }</style>
<script>
  (function(){
    const toggleColumnLink = document.getElementById('toggle-column-link');
    const table = document.getElementById('my-table');
    const headerCells = table.querySelectorAll('th:nth-child(9)');
    const dataCells = () => table.querySelectorAll('td:nth-child(9)');

    toggleColumnLink.addEventListener('click', function () {
      const isHidden = headerCells[0].classList.contains('hidden-column');
      headerCells.forEach(cell => cell.classList.toggle('hidden-column'));
      dataCells().forEach(cell => cell.classList.toggle('hidden-column'));
      toggleColumnLink.textContent = isHidden ? 'Hide Metadata' : 'Show Metadata';
    });
  })();

  // AJAX loader
  (function(){
    const form   = document.getElementById('changes-filters');
    const tbody  = document.getElementById('changes-tbody');
    const locEl  = document.getElementById('f-location');
    const teamEl = document.getElementById('f-team');
    const groupEl= document.getElementById('f-group');
    const qEl    = document.getElementById('f-q');
    const resetEl= document.getElementById('reset-filters');

    let typingTimer;
    const debounce = (fn, wait=300) => (...args) => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => fn.apply(this, args), wait);
    };

    function qs() {
      const p = new URLSearchParams();
      if (locEl.value)  p.set('location', locEl.value);
      if (teamEl.value) p.set('team_name', teamEl.value);
      if (groupEl.value) p.set('group', groupEl.value);
      if (qEl.value.trim()) p.set('q', qEl.value.trim());
      return p.toString();
    }

    function esc(s) {
      return (s ?? '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function fmt(dt) {
      if (!dt) return '';
      try { return new Date(dt).toLocaleString(); } catch { return dt; }
    }

    async function loadRows() {
      tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Loading…</td></tr>`;
      const url = `{% url 'changes_data' %}` + (qs() ? `?${qs()}` : '');
      const res = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
      const data = await res.json();
      renderRows(data.rows || []);
    }

    function renderRows(rows) {
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-muted">No results.</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(r => `
        <tr class="table-light">
          <td>${esc(r.change_id)}</td>
          <td style="word-wrap; break-word; white-space: normal;">${esc(r.location)}</td>
          <td style="word-wrap; break-word; white-space: normal;">${esc(r.team_name)}</td>
          <td>${esc(r.group)}</td>
          <td>${esc(r.class_type)}</td>
          <td>${esc(fmt(r.scheduled_start))}</td>
          <td>${esc(fmt(r.scheduled_end))}</td>
          <td>${esc(r.summary)}</td>
          <td class="hidden-column">${esc(r.metadata)}</td>
        </tr>
      `).join('');
    }

    form.addEventListener('submit', (e) => { e.preventDefault(); loadRows(); });
    locEl.addEventListener('change', loadRows);
    teamEl.addEventListener('change', loadRows);
    groupEl.addEventListener('change', loadRows);
    qEl.addEventListener('input', debounce(loadRows, 300));

    // reset
    resetEl.addEventListener('click', (e) => {
      e.preventDefault();
      locEl.value = '';
      teamEl.value = '';
      groupEl.value = '';
      qEl.value = '';
      loadRows();
    });

    // initial load
    loadRows();
  })();
</script>
{% endblock %}